name: "[CD] MAIN 클라이언트"
on:
  push:
    tags:
      - "v*"
    paths:
      - "client/**"
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: client
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Use Node JS
        uses: actions/setup-node@v2
        with:
          node-version: "16.x"

      - name: Make .env file
        run: |
          echo "VITE_SERVER_URL=${{ secrets.MAIN_VITE_SERVER_URL }}" >> .env
          echo "VITE_LOCAL_URL=${{ secrets.MAIN_VITE_LOCAL_URL }}" >> .env
          echo "VITE_GITHUB_AUTH_SERVER_URL=${{ secrets.MAIN_VITE_GITHUB_AUTH_SERVER_URL }}" >> .env
          echo "VITE_API_MODE=${{ secrets.MAIN_VITE_API_MODE }}" >> .env

      - name: Install Npm Clean
        run: npm ci

      - name: Build
        run: npm run build

      - name: Push to NCP Object Storage
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.MAIN_NCLOUD_BUCKET_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.MAIN_NCLOUD_BUCKET_SECRET_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2
        run: aws --endpoint-url=https://kr.object.ncloudstorage.com s3 cp --recursive ./dist s3://weview

  pull:
    runs-on: ubuntu-20.04
    needs: build-and-push
    steps:
      - name: Deploy with SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.MAIN_NCLOUD_HOST }}
          username: ${{ secrets.MAIN_NCLOUD_USERNAME }}
          password: ${{ secrets.MAIN_NCLOUD_PASSWORD }}
          port: ${{ secrets.MAIN_NCLOUD_PORT }}
          script: aws --endpoint-url=https://kr.object.ncloudstorage.com s3 cp --recursive s3://weview ./client
